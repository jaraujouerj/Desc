{{ define "main" }}
<style>
    .table-wrapper {
        max-width: 1000px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 50px;
        table-layout: fixed;
        background: white;
        min-width: 600px;
    }

    th,
    td {
        border: 1px solid #dee2e6;
        padding: 4px;
        text-align: center;
        vertical-align: middle;
        height: 60px;
    }

    th {
        background-color: #f8f9fa;
        font-weight: bold;
        font-size: 0.8rem;
    }

    .horario-label {
        width: 90px;
        background-color: #f8f9fa;
        font-size: 0.7rem;
        font-weight: bold;
    }

    .disciplina-bloco {
        border-radius: 4px;
        padding: 5px;
        height: 92%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 0.7rem;
        line-height: 1.1;
        margin: 2px;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .disciplina-nome {
        font-weight: bold;
        display: block;
        margin-bottom: 2px;
        color: #000;
        text-transform: uppercase;
        font-size: 0.65rem;
    }

    .info-extra {
        display: block;
        color: #444;
        font-size: 0.6rem;
    }
</style>



{{/* 1. Definição Global de Slots e Dias */}}
{{/* Lista completa com TODOS os horários para cálculos */}}
{{ $slotsPadrao := slice "07:00" "07:50" "08:40" "08:50" "09:40" "10:30" "10:40" "11:30" "12:20" "12:30" "13:20" "14:10"
"14:20" "15:10" "16:00" "16:10" "17:00" "17:50" "18:00" "18:50" "19:40" "20:30" }}
{{/* Lista apenas dos slots visíveis (que tem início de aula) */}}
{{ $slotsVisiveisRenderizar := slice "07:00" "07:50" "08:50" "09:40" "10:40" "11:30" "12:30" "13:20"
"14:20" "15:10" "16:10" "17:00" "18:00" "18:50" "19:40" "20:30" }}
{{ $dias := slice "Seg" "Ter" "Qua" "Qui" "Sex" }}

{{/* 2. Gerar Cores Únicas */}}
{{ $colors := slice "#FFADAD" "#FFD6A5" "#FDFFB6" "#CAFFBF" "#9BF6FF" "#A0C4FF" "#BDB2FF" "#FFC6FF" "#E0E0E0" }}
{{ $colorMap := dict }}{{ $idx := 0 }}
{{ range .Site.Data.pt.horarios.turmas }}{{ range .horarios }}
{{ if not (isset $colorMap .disciplina) }}
{{ $colorMap = merge $colorMap (dict .disciplina (index $colors $idx)) }}
{{ $idx = mod (add $idx 1) (len $colors) }}{{ end }}
{{ end }}{{ end }}

{{ range .Site.Data.pt.horarios.turmas }}
{{ $turma := . }}
{{ $turmaID := anchorize $turma.nome }}
<h2>{{ $turma.nome }}</h2>

{{/* Mapeamento de aulas e Identificação de Slots Visíveis */}}
{{ $mapaAulas := dict }}{{ $temAulaNoSlot := dict }}
{{ range $turma.horarios }}
{{/* Normaliza 7:00 para 07:00 */}}
{{ $h_ini := printf "%s" .inicio }}{{ if eq (len $h_ini) 4 }}{{ $h_ini = printf "0%s" $h_ini }}{{ end }}
{{ $h_fim := printf "%s" .fim }}{{ if eq (len $h_fim) 4 }}{{ $h_fim = printf "0%s" $h_fim }}{{ end }}

{{ $k := printf "%s-%s" .dia $h_ini }}
{{ $aulaNormalizada := merge . (dict "inicio" $h_ini "fim" $h_fim) }}
{{ $mapaAulas = merge $mapaAulas (dict $k $aulaNormalizada) }}
{{ $temAulaNoSlot = merge $temAulaNoSlot (dict $h_ini true) }}
{{ end }}

{{/* Encontra o primeiro e último slot com aula */}}
{{ $primeiroSlot := "" }}{{ $ultimoSlot := "" }}
{{ $temAulaNoSlot := dict }}
{{ range $turma.horarios }}
{{/* Normaliza os horários */}}
{{ $h_ini := printf "%s" .inicio }}{{ if eq (len $h_ini) 4 }}{{ $h_ini = printf "0%s" $h_ini }}{{ end }}
{{ $h_fim := printf "%s" .fim }}{{ if eq (len $h_fim) 4 }}{{ $h_fim = printf "0%s" $h_fim }}{{ end }}
{{ $temAulaNoSlot = merge $temAulaNoSlot (dict $h_ini true) }}
{{ end }}

{{ range $slotsPadrao }}
{{ if isset $temAulaNoSlot . }}
{{ if eq $primeiroSlot "" }}{{ $primeiroSlot = . }}{{ end }}
{{ $ultimoSlot = . }}
{{ end }}
{{ end }}

{{/* Agora encontra o último slot que qualquer aula TERMINA */}}
{{ range $turma.horarios }}
{{ $h_fim := printf "%s" .fim }}{{ if eq (len $h_fim) 4 }}{{ $h_fim = printf "0%s" $h_fim }}{{ end }}
{{ range $slotsPadrao }}
{{ if eq . $h_fim }}
{{ if eq $ultimoSlot "" }}{{ $ultimoSlot = . }}{{ end }}
{{ if ge . $ultimoSlot }}{{ $ultimoSlot = . }}{{ end }}
{{ end }}
{{ end }}
{{ end }}

{{/* Cria lista de slots do período em uso (todos os slots entre o primeiro e último) */}}
{{ $slotsVisiveis := slice }}
{{ $incluindo := false }}
{{ range $slotsPadrao }}
{{ if eq . $primeiroSlot }}{{ $incluindo = true }}{{ end }}
{{ if $incluindo }}{{ $slotsVisiveis = $slotsVisiveis | append . }}{{ end }}
{{ if eq . $ultimoSlot }}{{ $incluindo = false }}{{ end }}
{{ end }}

{{/* Filtra apenas os slots visíveis para renderização */}}
{{ $slotsRenderizar := slice }}
{{ range $slotsVisiveis }}
{{ $slot := . }}
{{ $ehVisivel := false }}
{{ range $slotsVisiveisRenderizar }}
{{ if eq . $slot }}{{ $ehVisivel = true }}{{ end }}
{{ end }}
{{ if $ehVisivel }}{{ $slotsRenderizar = $slotsRenderizar | append $slot }}{{ end }}
{{ end }}

{{/* Scratch exclusivo para esta turma */}}
{{ $scratchKey := printf "ocupado_%s" $turmaID }}
{{ $.Scratch.Set $scratchKey dict }}

<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th class="horario-label">Horário</th>
                {{ range $dias }}<th>{{ . }}</th>{{ end }}
            </tr>
        </thead>
        <tbody>
            {{ range $idx_linha, $h := $slotsRenderizar }}
            {{ $h_fim := "" }}
            {{ if eq $h "07:00" }}{{ $h_fim = "07:50" }}{{ else if eq $h "07:50" }}{{ $h_fim = "08:40" }}{{ else if eq
            $h "08:50" }}{{ $h_fim = "09:40" }}{{ else if eq $h "09:40" }}{{ $h_fim = "10:30" }}{{ else if eq $h "10:40"
            }}{{ $h_fim = "11:30" }}{{ else if eq $h "11:30" }}{{ $h_fim = "12:20" }}{{ else if eq $h "12:30" }}{{
            $h_fim = "13:20" }}{{ else if eq $h "13:20" }}{{ $h_fim = "14:10" }}{{ else if eq $h "14:20" }}{{ $h_fim =
            "15:10" }}{{ else if eq $h "15:10" }}{{ $h_fim = "16:00" }}{{ else if eq $h "16:10" }}{{ $h_fim = "17:00"
            }}{{ else if eq $h "17:00" }}{{ $h_fim = "17:50" }}{{ else if eq $h "18:00" }}{{ $h_fim = "18:50" }}{{ else
            if eq $h "18:50" }}{{ $h_fim = "19:40" }}{{ else if eq $h "19:40" }}{{ $h_fim = "20:30" }}{{ end }}
            <tr>
                <td class="horario-label">{{ $h }}<br>{{ $h_fim }}</td>
                {{ range $d := $dias }}
                {{ $chaveCel := printf "%s-%s" $d $h }}
                {{ $jaPreenchido := index ($.Scratch.Get $scratchKey) $chaveCel }}

                {{ if not $jaPreenchido }}
                {{ if isset $mapaAulas $chaveCel }}
                {{ $aula := index $mapaAulas $chaveCel }}

                {{/* CÁLCULO DO ROWSPAN: conta quantos slots VISÍVEIS esta aula abrange */}}
                {{ $span := 1 }}
                {{ $parar := false }}
                {{ $aulafimNum := (replaceRE ":" "" $aula.fim) }}
                {{ range $idx_next, $h_next := $slotsRenderizar }}
                {{ if and (gt $idx_next $idx_linha) (not $parar) }}
                {{ $h_nextNum := (replaceRE ":" "" $h_next) }}
                {{ if lt $h_nextNum $aulafimNum }}
                {{ $span = add $span 1 }}
                {{ $k_ocupa := printf "%s-%s" $d $h_next }}
                {{ $.Scratch.SetInMap $scratchKey $k_ocupa true }}
                {{ else }}
                {{ $parar = true }}
                {{ end }}
                {{ end }}
                {{ end }}

                <td rowspan="{{ $span }}">
                    <div class="disciplina-bloco" style="background-color: {{ index $colorMap $aula.disciplina }};">
                        <span class="disciplina-nome">{{ $aula.disciplina }}</span>
                        <span class="info-extra">{{ $aula.professor }}</span>
                        <span class="info-extra">{{ $aula.sala }}</span>
                    </div>
                </td>
                {{ else }}
                <td></td>
                {{ end }}
                {{ end }}
                {{ end }}
            </tr>
            {{ end }}
        </tbody>
    </table>
</div>
{{ end }}
{{ end }}